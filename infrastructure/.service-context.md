# ğŸ—ï¸ INFRAESTRUTURA - CONTEXTO

## ğŸ“ Arquitetura Kubernetes (Estado Atual)
Cluster Kubernetes autogerenciado em AWS EC2 ARM64 com microsserviÃ§os em namespace 'fiapx'.

## ğŸŒ Acesso e ConfiguraÃ§Ã£o
- **Kubeconfig**: kubeconfig.yaml (na raiz do projeto)
- **Namespace**: fiapx
- **Worker Node**: worker.wecando.click (ubuntu, chave ~/.ssh/keyPrincipal.pem)
- **Ingress**: Nginx Ingress Controller com Let's Encrypt
- **DomÃ­nios**:
  - Frontend: https://fiapx.wecando.click
  - APIs: https://api.wecando.click

## ğŸ—„ï¸ Componentes Base Deployados

### PostgreSQL
- **Service**: postgres (interno)
- **Port**: 5432
- **Database**: fiapx_auth
- **Usado por**: auth-service
- **Persistent Volume**: Configurado

### RabbitMQ
### Redis
- **Service**: redis (interno)
- **Port**: 6380 (conforme processing-service)
- **Usado por**: processing-service (cache de filas)
- **Persistent Volume**: Configurado

### RabbitMQ
- **Service**: rabbitmq (interno)
- **Port**: 5672 (AMQP), 15672 (Management)
- **Filas Ativas**:
  - `video_processing` - Jobs de processamento (upload â†’ processing)
  - `video_processed` - Resultados (processing â†’ storage)
  - `notifications` - Emails (processing â†’ notification)
- **Usado por**: upload-service, processing-service, storage-service, notification-service

### MinIO
- **Service**: minio (interno)
- **Port**: 9000 (API), 9001 (Console)
- **Buckets**:
  - `video-uploads` - VÃ­deos originais
  - `video-processed` - ZIPs de frames processados
- **Usado por**: upload-service, processing-service, storage-service

## ğŸ”§ Ingress e SSL (Estado Atual)
- **Nginx Ingress Controller**: Gerencia roteamento
- **Cert-Manager**: Let's Encrypt para SSL automÃ¡tico
- **Certificados**: fiapx-tls-secret (fiapx.wecando.click, api.wecando.click)
- **CORS**: Configurado para frontend HTTPS

## ğŸ”§ Manifests Kubernetes
```
infrastructure/kubernetes/
â”œâ”€â”€ namespace.yaml
â”œâ”€â”€ postgres/
â”œâ”€â”€ redis/
â”œâ”€â”€ rabbitmq/
â”œâ”€â”€ minio/
â”œâ”€â”€ auth-service/
â”œâ”€â”€ upload-service/
â”œâ”€â”€ processing-service/
â”œâ”€â”€ storage-service/
â”œâ”€â”€ notification-service/
â””â”€â”€ frontend/ (opcional)
```

## ğŸš€ Deploy Completo
```bash
# 1. SSH Tunnel
ssh -i ~/.ssh/keyPrincipal.pem -fN ubuntu@worker.wecando.click

# 2. Deploy infraestrutura base
kubectl --kubeconfig=kubeconfig.yaml apply -f infrastructure/kubernetes/namespace.yaml
kubectl --kubeconfig=kubeconfig.yaml apply -f infrastructure/kubernetes/postgres/
kubectl --kubeconfig=kubeconfig.yaml apply -f infrastructure/kubernetes/redis/
kubectl --kubeconfig=kubeconfig.yaml apply -f infrastructure/kubernetes/rabbitmq/
kubectl --kubeconfig=kubeconfig.yaml apply -f infrastructure/kubernetes/minio/

# 3. Deploy certificados e ingress
kubectl --kubeconfig=kubeconfig.yaml apply -f infrastructure/kubernetes/cert-manager/
kubectl --kubeconfig=kubeconfig.yaml apply -f infrastructure/kubernetes/ingress/

# 4. Deploy serviÃ§os (apÃ³s build das imagens Docker)
kubectl --kubeconfig=kubeconfig.yaml apply -f infrastructure/kubernetes/auth-service/
kubectl --kubeconfig=kubeconfig.yaml apply -f infrastructure/kubernetes/upload-service/
kubectl --kubeconfig=kubeconfig.yaml apply -f infrastructure/kubernetes/processing-service/
kubectl --kubeconfig=kubeconfig.yaml apply -f infrastructure/kubernetes/storage-service/
kubectl --kubeconfig=kubeconfig.yaml apply -f infrastructure/kubernetes/notification-service.yaml
kubectl --kubeconfig=kubeconfig.yaml apply -f infrastructure/kubernetes/frontend/
```

## ğŸ” Comandos de Monitoramento (Estado Atual)
```bash
# Status geral do cluster
kubectl --kubeconfig=kubeconfig.yaml get pods -n fiapx -o wide

# Services e ingress
kubectl --kubeconfig=kubeconfig.yaml get svc,ingress -n fiapx

# Certificados SSL
kubectl --kubeconfig=kubeconfig.yaml get certificates -n fiapx

# Logs de um serviÃ§o especÃ­fico  
kubectl --kubeconfig=kubeconfig.yaml logs -f -n fiapx deployment/auth-service

# Restart de um deployment
kubectl --kubeconfig=kubeconfig.yaml rollout restart deployment/auth-service -n fiapx

# Escalar um serviÃ§o
kubectl --kubeconfig=kubeconfig.yaml scale deployment processing-service --replicas=3 -n fiapx
```

## âš ï¸ ObservaÃ§Ãµes Importantes
- **Cluster ARM64**: Todas as imagens sÃ£o compatÃ­veis
- **Persistent Volumes**: Configurados para PostgreSQL, Redis e MinIO
- **SSL AutomÃ¡tico**: Let's Encrypt via cert-manager
- **Auto-scaling**: HPA configurado para processing-service (1-5 replicas)
- **Resource Limits**: CPU e Memory definidos para todos os pods
- **CORS**: Configurado para frontend HTTPS
- **Secrets**: ses-email-secrets necessÃ¡rio para notification-service
